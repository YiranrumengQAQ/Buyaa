<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>æ™ºèƒ½è¿åŠ¨æ£€æµ‹ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        /* PCç«¯404æç¤º */
        .desktop-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .desktop-warning h1 {
            font-size: 72px;
            margin-bottom: 20px;
        }

        .desktop-warning p {
            font-size: 24px;
            opacity: 0.9;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .battery-icon {
            font-size: 20px;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            padding: 70px 16px 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* è§†é¢‘é¢„è§ˆ */
        .video-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            margin-bottom: 16px;
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .detection-box {
            position: absolute;
            border: 3px solid #4caf50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: border-color 0.2s, box-shadow 0.2s;
            pointer-events: none;
        }

        .detection-box.active {
            border-color: #f44336;
            box-shadow: 0 0 30px rgba(244, 67, 54, 0.8);
        }

        .detection-box::before,
        .detection-box::after,
        .corner-br::before,
        .corner-br::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid currentColor;
        }

        .detection-box::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .detection-box::after {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
        }

        .corner-br::before {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
        }

        .corner-br::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:active {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é¢„è®¾æ¨¡å¼é€‰æ‹©å™¨ */
        .preset-modes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .preset-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            text-align: center;
        }

        .preset-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            color: #667eea;
            font-weight: 600;
        }

        /* æ»‘å—æ§åˆ¶ */
        .slider-group {
            margin-bottom: 16px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* é«˜çº§è®¾ç½®é¢æ¿ */
        .advanced-settings {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .advanced-settings.show {
            max-height: 1500px;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* ç”µæ± ä¿¡æ¯ */
        .battery-info {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .battery-percent {
            font-size: 42px;
            font-weight: 700;
            color: #667eea;
        }

        .battery-details {
            flex: 1;
        }

        .battery-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .battery-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s;
        }

        .battery-fill.low {
            background: linear-gradient(90deg, #f44336, #ff9800);
        }

        .battery-text {
            font-size: 12px;
            color: #666;
        }

        /* æˆªå›¾ç”»å»Š */
        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .screenshot-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: 1;
        }

        .screenshot-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .screenshot-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px;
            font-size: 10px;
            text-align: center;
        }

        /* å…¨å±æŸ¥çœ‹ */
        .fullscreen-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .fullscreen-viewer img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* çœç”µé®ç½© */
        .dim-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        /* å¼€å…³æŒ‰é’® */
        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 26px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: #667eea;
        }

        input:checked + .switch-slider:before {
            transform: translateX(22px);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å“åº”å¼ */
        @media (min-width: 768px) {
            .desktop-warning {
                display: flex !important;
            }

            .container {
                display: none;
            }

            .status-bar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- PCç«¯è­¦å‘Š -->
    <div class="desktop-warning">
        <h1>404</h1>
        <p>âš ï¸ æœ¬åº”ç”¨ä»…æ”¯æŒç§»åŠ¨è®¾å¤‡è®¿é—®</p>
        <p style="margin-top: 20px; font-size: 18px;">è¯·ä½¿ç”¨æ‰‹æœºæˆ–å¹³æ¿è®¾å¤‡æ‰«æäºŒç»´ç è®¿é—®</p>
    </div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <span>ğŸ¥</span>
            <span id="status-text">å°±ç»ª</span>
        </div>
        <div class="status-item">
            <span class="battery-icon" id="battery-icon">ğŸ”‹</span>
            <span id="battery-status">--</span>
        </div>
    </div>

    <!-- çœç”µé®ç½© -->
    <div class="dim-overlay" id="dimOverlay"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- è§†é¢‘é¢„è§ˆå¡ç‰‡ -->
        <div class="card">
            <div class="card-title">ğŸ“¹ å®æ—¶ç›‘æ§</div>
            <div class="video-container" id="videoContainer">
                <video id="video" autoplay playsinline muted></video>
                <div class="detection-box corner-br" id="detectionBox"></div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="startBtn">
                    <span>â–¶ï¸</span>
                    <span>å¼€å§‹æ£€æµ‹</span>
                </button>
                <button class="btn btn-secondary" id="switchCameraBtn">
                    <span>ğŸ”„</span>
                </button>
            </div>
        </div>

        <!-- é¢„è®¾æ¨¡å¼ -->
        <div class="card">
            <div class="card-title">âš™ï¸ é¢„è®¾æ¨¡å¼</div>
            <div class="preset-modes">
                <button class="preset-btn active" data-preset="balanced">âš–ï¸ å¹³è¡¡æ¨¡å¼</button>
                <button class="preset-btn" data-preset="sensitive">ğŸ” é«˜çµæ•åº¦</button>
                <button class="preset-btn" data-preset="eco">ğŸ”‹ çœç”µæ¨¡å¼</button>
                <button class="preset-btn" data-preset="security">ğŸ”’ å®‰é˜²æ¨¡å¼</button>
                <button class="preset-btn" data-preset="silent">ğŸ”‡ é™éŸ³æ¨¡å¼</button>
                <button class="preset-btn" data-preset="custom">âš™ï¸ è‡ªå®šä¹‰</button>
            </div>
        </div>

        <!-- æ£€æµ‹è®¾ç½® -->
        <div class="card">
            <div class="card-title">ğŸ›ï¸ æ£€æµ‹è®¾ç½®</div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>æ£€æµ‹åŒºåŸŸå¤§å°</span>
                    <span id="detectionAreaValue">60%</span>
                </div>
                <input type="range" class="slider" id="detectionArea" min="30" max="100" value="60">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>éœ‡åŠ¨è§¦å‘é˜ˆå€¼</span>
                    <span id="vibrateThresholdValue">50%</span>
                </div>
                <input type="range" class="slider" id="vibrateThreshold" min="10" max="100" value="50">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>æˆªå›¾è§¦å‘é˜ˆå€¼</span>
                    <span id="screenshotThresholdValue">70%</span>
                </div>
                <input type="range" class="slider" id="screenshotThreshold" min="10" max="100" value="70">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>é€šçŸ¥è§¦å‘é˜ˆå€¼</span>
                    <span id="notificationThresholdValue">60%</span>
                </div>
                <input type="range" class="slider" id="notificationThreshold" min="10" max="100" value="60">
            </div>

            <!-- é«˜çº§è®¾ç½® -->
            <div class="advanced-settings" id="advancedSettings">
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <div class="slider-group">
                    <div class="slider-label">
                        <span>æ£€æµ‹çµæ•åº¦</span>
                        <span id="sensitivityValue">50</span>
                    </div>
                    <input type="range" class="slider" id="sensitivity" min="10" max="90" value="50">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>åƒç´ å˜åŒ–é˜ˆå€¼</span>
                        <span id="pixelThresholdValue">40</span>
                    </div>
                    <input type="range" class="slider" id="pixelThreshold" min="10" max="100" value="40">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>æ£€æµ‹é¢‘ç‡ (å¸§/ç§’)</span>
                        <span id="frameRateValue">15</span>
                    </div>
                    <input type="range" class="slider" id="frameRate" min="5" max="30" value="15">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>æœ€å°æŒç»­æ—¶é—´ (ms)</span>
                        <span id="minDurationValue">500</span>
                    </div>
                    <input type="range" class="slider" id="minDuration" min="100" max="2000" step="100" value="500">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>é‡‡æ ·æ­¥è¿› (åƒç´ )</span>
                        <span id="sampleStepValue">4</span>
                    </div>
                    <input type="range" class="slider" id="sampleStep" min="2" max="10" value="4">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>éŸ³é‡</span>
                        <span id="volumeValue">50%</span>
                    </div>
                    <input type="range" class="slider" id="volume" min="0" max="100" value="50">
                </div>

                <div class="switch-container">
                    <span>å¯ç”¨éŸ³é¢‘æç¤º</span>
                    <label class="switch">
                        <input type="checkbox" id="audioEnabled" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>éœ‡åŠ¨é—´éš” (ç§’)</span>
                        <span id="vibrateIntervalValue">2.0</span>
                    </div>
                    <input type="range" class="slider" id="vibrateInterval" min="0.5" max="5" step="0.5" value="2">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>æˆªå›¾é—´éš” (ç§’)</span>
                        <span id="screenshotIntervalValue">3</span>
                    </div>
                    <input type="range" class="slider" id="screenshotInterval" min="1" max="10" value="3">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>é€šçŸ¥é—´éš” (ç§’)</span>
                        <span id="notificationIntervalValue">10</span>
                    </div>
                    <input type="range" class="slider" id="notificationInterval" min="3" max="30" value="10">
                </div>

                <div class="switch-container">
                    <span>æŒç»­ç›‘æ§æ¨¡å¼</span>
                    <label class="switch">
                        <input type="checkbox" id="continuousMode" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- ç”µæ± ä¿¡æ¯ -->
        <div class="card">
            <div class="card-title">ğŸ”‹ ç”µæ± çŠ¶æ€</div>
            <div class="battery-info">
                <div class="battery-percent" id="batteryPercent">--</div>
                <div class="battery-details">
                    <div class="battery-text" id="batteryCharging">æ£€æµ‹ä¸­...</div>
                    <div class="battery-bar">
                        <div class="battery-fill" id="batteryFill" style="width: 0%"></div>
                    </div>
                    <div class="battery-text" id="batteryTime">--</div>
                </div>
            </div>

            <div class="switch-container">
                <span>è‡ªåŠ¨å˜æš— (çœç”µ)</span>
                <label class="switch">
                    <input type="checkbox" id="autoDimEnabled" checked>
                    <span class="switch-slider"></span>
                </label>
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>å˜æš—è§¦å‘æ—¶é—´ (ç§’)</span>
                    <span id="dimTimeoutValue">30</span>
                </div>
                <input type="range" class="slider" id="dimTimeout" min="10" max="120" step="10" value="30">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>äº®åº¦é™ä½ç¨‹åº¦</span>
                    <span id="dimLevelValue">70%</span>
                </div>
                <input type="range" class="slider" id="dimLevel" min="30" max="90" value="70">
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="card">
            <div class="card-title">ğŸ“Š ç»Ÿè®¡æ•°æ®</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="detectionCount">0</span>
                    <span class="stat-label">æ£€æµ‹æ¬¡æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="vibrateCount">0</span>
                    <span class="stat-label">éœ‡åŠ¨æ¬¡æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="screenshotCount">0</span>
                    <span class="stat-label">æˆªå›¾æ•°é‡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="notificationCount">0</span>
                    <span class="stat-label">é€šçŸ¥æ¬¡æ•°</span>
                </div>
            </div>
        </div>

        <!-- æˆªå›¾ç”»å»Š -->
        <div class="card">
            <div class="card-title">
                ğŸ“¸ æˆªå›¾è®°å½•
                <button class="btn btn-secondary" id="clearScreenshots" style="margin-left: auto; padding: 8px 16px; font-size: 12px;">æ¸…é™¤å…¨éƒ¨</button>
            </div>
            <div class="screenshots-grid" id="screenshotsGrid">
                <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                    æš‚æ— æˆªå›¾
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±æŸ¥çœ‹å™¨ -->
    <div class="fullscreen-viewer" id="fullscreenViewer">
        <button class="close-fullscreen" id="closeFullscreen">âœ•</button>
        <img id="fullscreenImage" src="" alt="æˆªå›¾">
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast"></div>

    <!-- éšè—çš„Canvas -->
    <canvas id="canvas"></canvas>
    <canvas id="bufferCanvas"></canvas>

    <script>
        // ============ å…¨å±€å˜é‡ ============
        let video, canvas, ctx, bufferCanvas, bufferCtx;
        let isDetecting = false;
        let previousImageData = null;
        let currentCamera = 'user';
        let wakeLock = null;
        let detectionInterval = null;
        let audioContext = null;

        // ç»Ÿè®¡æ•°æ®
        let stats = {
            detections: 0,
            vibrations: 0,
            screenshots: 0,
            notifications: 0
        };

        // é…ç½®å‚æ•°
        let config = {
            detectionArea: 60,
            vibrateThreshold: 50,
            screenshotThreshold: 70,
            notificationThreshold: 60,
            sensitivity: 50,
            pixelThreshold: 40,
            frameRate: 15,
            minDuration: 500,
            sampleStep: 4,
            volume: 50,
            audioEnabled: true,
            vibrateInterval: 2,
            screenshotInterval: 3,
            notificationInterval: 10,
            continuousMode: true,
            autoDimEnabled: true,
            dimTimeout: 30,
            dimLevel: 70
        };

        // æ—¶é—´æˆ³æ§åˆ¶
        let lastVibrateTime = 0;
        let lastScreenshotTime = 0;
        let lastNotificationTime = 0;
        let motionStartTime = 0;
        let isInMotion = false;

        // æˆªå›¾å­˜å‚¨
        let screenshots = [];
        const MAX_SCREENSHOTS = 50;

        // é¢„è®¾é…ç½®
        const presets = {
            balanced: {
                sensitivity: 50, pixelThreshold: 40, frameRate: 15, minDuration: 500, sampleStep: 4,
                vibrateThreshold: 50, screenshotThreshold: 70, notificationThreshold: 60
            },
            sensitive: {
                sensitivity: 80, pixelThreshold: 20, frameRate: 25, minDuration: 200, sampleStep: 2,
                vibrateThreshold: 30, screenshotThreshold: 50, notificationThreshold: 40
            },
            eco: {
                sensitivity: 30, pixelThreshold: 60, frameRate: 8, minDuration: 1000, sampleStep: 8,
                vibrateThreshold: 70, screenshotThreshold: 90, notificationThreshold: 80
            },
            security: {
                sensitivity: 90, pixelThreshold: 15, frameRate: 30, minDuration: 100, sampleStep: 2,
                vibrateThreshold: 20, screenshotThreshold: 30, notificationThreshold: 25
            },
            silent: {
                sensitivity: 50, pixelThreshold: 40, frameRate: 15, minDuration: 500, sampleStep: 4,
                vibrateThreshold: 100, screenshotThreshold: 70, notificationThreshold: 100
            }
        };

        // çœç”µæ¨¡å¼
        let dimTimer = null;
        let isDimmed = false;
        let userActivityTimer = null;

        // ç”µæ± ç›‘æ§
        let batteryChargeHistory = [];

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            initElements();
            initEventListeners();
            loadSettings();
            checkDeviceType();
            initBatteryMonitor();
            requestNotificationPermission();
            showWelcomeToast();
            initUserActivityTracking();
        });

        function initElements() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            bufferCanvas = document.getElementById('bufferCanvas');
            bufferCtx = bufferCanvas.getContext('2d', { willReadFrequently: true });
        }

        function initEventListeners() {
            // æ§åˆ¶æŒ‰é’®
            document.getElementById('startBtn').addEventListener('click', toggleDetection);
            document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
            document.getElementById('clearScreenshots').addEventListener('click', clearAllScreenshots);

            // é¢„è®¾æ¨¡å¼
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    applyPreset(e.target.dataset.preset);
                });
            });

            // æ»‘å—äº‹ä»¶
            const sliders = ['detectionArea', 'vibrateThreshold', 'screenshotThreshold', 
                            'notificationThreshold', 'sensitivity', 'pixelThreshold', 
                            'frameRate', 'minDuration', 'sampleStep', 'volume',
                            'vibrateInterval', 'screenshotInterval', 'notificationInterval',
                            'dimTimeout', 'dimLevel'];

            sliders.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', (e) => {
                    updateSliderValue(id, e.target.value);
                });
            });

            // å¼€å…³
            document.getElementById('audioEnabled').addEventListener('change', (e) => {
                config.audioEnabled = e.target.checked;
                saveSettings();
            });

            document.getElementById('continuousMode').addEventListener('change', (e) => {
                config.continuousMode = e.target.checked;
                saveSettings();
            });

            document.getElementById('autoDimEnabled').addEventListener('change', (e) => {
                config.autoDimEnabled = e.target.checked;
                saveSettings();
                if (!e.target.checked) {
                    clearDimTimer();
                    restoreBrightness();
                } else if (isDetecting) {
                    startDimTimer();
                }
            });

            // å…¨å±æŸ¥çœ‹
            document.getElementById('closeFullscreen').addEventListener('click', closeFullscreen);
            document.getElementById('fullscreenViewer').addEventListener('click', (e) => {
                if (e.target.id === 'fullscreenViewer') closeFullscreen();
            });

            // æ£€æµ‹åŒºåŸŸå˜åŒ–
            document.getElementById('detectionArea').addEventListener('input', updateDetectionBox);

            // é¡µé¢å¯è§æ€§
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function updateSliderValue(id, value) {
            const numValue = parseFloat(value);
            config[id] = numValue;

            let displayValue = numValue;
            let suffix = '';

            if (id.includes('Threshold') || id.includes('Level')) {
                suffix = '%';
            } else if (id.includes('Interval') || id.includes('Timeout')) {
                suffix = 'ç§’';
                if (id === 'vibrateInterval') displayValue = numValue.toFixed(1);
            } else if (id === 'frameRate') {
                suffix = '';
            } else if (id === 'minDuration') {
                suffix = 'ms';
            } else if (id === 'volume') {
                suffix = '%';
            }

            document.getElementById(id + 'Value').textContent = displayValue + suffix;

            if (id === 'detectionArea') {
                updateDetectionBox();
            }

            if (isDetecting && id === 'frameRate') {
                restartDetection();
            }

            saveSettings();
        }

        function applyPreset(presetName) {
            if (presetName === 'custom') {
                document.getElementById('advancedSettings').classList.add('show');
            } else {
                document.getElementById('advancedSettings').classList.remove('show');
                const preset = presets[presetName];
                if (preset) {
                    Object.keys(preset).forEach(key => {
                        config[key] = preset[key];
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = preset[key];
                            updateSliderValue(key, preset[key]);
                        }
                    });
                }
            }
            saveSettings();
        }

        // ============ æ‘„åƒå¤´æ§åˆ¶ ============
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    bufferCanvas.width = video.videoWidth;
                    bufferCanvas.height = video.videoHeight;
                    updateDetectionBox();
                };

                return true;
            } catch (error) {
                showToast('âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥: ' + error.message);
                return false;
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        async function switchCamera() {
            currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            if (isDetecting) {
                stopDetection();
                await startCamera();
                startDetection();
            }
        }

        // ============ è¿åŠ¨æ£€æµ‹ ============
        async function toggleDetection() {
            if (isDetecting) {
                stopDetection();
            } else {
                await startDetection();
            }
        }

        async function startDetection() {
            const cameraStarted = await startCamera();
            if (!cameraStarted) return;

            isDetecting = true;
            document.getElementById('startBtn').innerHTML = '<span>â¸ï¸</span><span>åœæ­¢æ£€æµ‹</span>';
            document.getElementById('status-text').textContent = 'è¿è¡Œä¸­';

            await requestWakeLock();

            previousImageData = null;
            const interval = 1000 / config.frameRate;
            detectionInterval = setInterval(detectMotion, interval);

            if (config.autoDimEnabled) {
                startDimTimer();
            }

            showToast('âœ… æ£€æµ‹å·²å¯åŠ¨');

            // 5ç§’åæ˜¾ç¤ºé”å±æç¤º
            setTimeout(() => {
                if (isDetecting) {
                    showToast('âš ï¸ è¯·å‹¿é”å±,å¦åˆ™æ£€æµ‹å°†æš‚åœ', 5000);
                }
            }, 5000);
        }

        function stopDetection() {
            isDetecting = false;
            document.getElementById('startBtn').innerHTML = '<span>â–¶ï¸</span><span>å¼€å§‹æ£€æµ‹</span>';
            document.getElementById('status-text').textContent = 'å·²åœæ­¢';

            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }

            releaseWakeLock();
            stopCamera();
            clearDimTimer();
            restoreBrightness();

            document.getElementById('detectionBox').classList.remove('active');

            showToast('â¹ï¸ æ£€æµ‹å·²åœæ­¢');
        }

        function restartDetection() {
            if (isDetecting) {
                stopDetection();
                setTimeout(() => startDetection(), 100);
            }
        }

        function detectMotion() {
            if (!video.readyState === video.HAVE_ENOUGH_DATA) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const detectionSize = config.detectionArea / 100;
            const detectionWidth = Math.floor(canvas.width * detectionSize);
            const detectionHeight = Math.floor(canvas.height * detectionSize);
            const startX = Math.floor((canvas.width - detectionWidth) / 2);
            const startY = Math.floor((canvas.height - detectionHeight) / 2);

            const currentImageData = ctx.getImageData(startX, startY, detectionWidth, detectionHeight);

            if (previousImageData) {
                const motionIntensity = compareFrames(currentImageData, previousImageData);

                if (motionIntensity > config.sensitivity) {
                    handleMotionDetected(motionIntensity);
                } else {
                    handleNoMotion();
                }
            }

            previousImageData = currentImageData;
        }

        function compareFrames(current, previous) {
            const data1 = current.data;
            const data2 = previous.data;
            let diffPixels = 0;
            const step = config.sampleStep * 4;

            for (let i = 0; i < data1.length; i += step) {
                const diff = Math.abs(data1[i] - data2[i]) +
                            Math.abs(data1[i+1] - data2[i+1]) +
                            Math.abs(data1[i+2] - data2[i+2]);

                if (diff > config.pixelThreshold) {
                    diffPixels++;
                }
            }

            const totalPixels = data1.length / (step * 3);
            return (diffPixels / totalPixels) * 100;
        }

        function handleMotionDetected(intensity) {
            const now = Date.now();

            if (!isInMotion) {
                isInMotion = true;
                motionStartTime = now;
            }

            const motionDuration = now - motionStartTime;

            if (motionDuration >= config.minDuration || config.continuousMode) {
                stats.detections++;
                document.getElementById('detectionCount').textContent = stats.detections;
                document.getElementById('detectionBox').classList.add('active');

                // éœ‡åŠ¨
                if (intensity >= config.vibrateThreshold && 
                    now - lastVibrateTime >= config.vibrateInterval * 1000) {
                    triggerVibration();
                    lastVibrateTime = now;
                }

                // æˆªå›¾
                if (intensity >= config.screenshotThreshold && 
                    now - lastScreenshotTime >= config.screenshotInterval * 1000) {
                    takeScreenshot(intensity);
                    lastScreenshotTime = now;
                }

                // é€šçŸ¥
                if (intensity >= config.notificationThreshold && 
                    now - lastNotificationTime >= config.notificationInterval * 1000) {
                    sendNotification(intensity);
                    lastNotificationTime = now;
                }

                // éŸ³é¢‘
                if (config.audioEnabled && intensity >= config.vibrateThreshold) {
                    playBeep();
                }
            }
        }

        function handleNoMotion() {
            isInMotion = false;
            motionStartTime = 0;
            document.getElementById('detectionBox').classList.remove('active');
        }

        // ============ åé¦ˆåŠŸèƒ½ ============
        function triggerVibration() {
            if ('vibrate' in navigator) {
                navigator.vibrate(200);
                stats.vibrations++;
                document.getElementById('vibrateCount').textContent = stats.vibrations;
            }
        }

        function takeScreenshot(intensity) {
            bufferCtx.drawImage(video, 0, 0, bufferCanvas.width, bufferCanvas.height);

            const timestamp = new Date().toLocaleString('zh-CN');
            const dataUrl = bufferCanvas.toDataURL('image/jpeg', 0.8);

            screenshots.unshift({ url: dataUrl, time: timestamp, intensity: intensity.toFixed(1) });

            if (screenshots.length > MAX_SCREENSHOTS) {
                screenshots.pop();
            }

            stats.screenshots++;
            document.getElementById('screenshotCount').textContent = stats.screenshots;

            updateScreenshotsGrid();
        }

        function updateScreenshotsGrid() {
            const grid = document.getElementById('screenshotsGrid');

            if (screenshots.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">æš‚æ— æˆªå›¾</div>';
                return;
            }

            grid.innerHTML = screenshots.map((shot, index) => `
                <div class="screenshot-item" onclick="viewScreenshot(${index})">
                    <img src="${shot.url}" alt="æˆªå›¾">
                    <div class="screenshot-info">
                        ${shot.time.split(' ')[1]}<br>å¼ºåº¦: ${shot.intensity}%
                    </div>
                </div>
            `).join('');
        }

        function viewScreenshot(index) {
            document.getElementById('fullscreenImage').src = screenshots[index].url;
            document.getElementById('fullscreenViewer').style.display = 'flex';
        }

        function closeFullscreen() {
            document.getElementById('fullscreenViewer').style.display = 'none';
        }

        function clearAllScreenshots() {
            if (screenshots.length === 0) return;

            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æˆªå›¾å—?')) {
                screenshots = [];
                stats.screenshots = 0;
                document.getElementById('screenshotCount').textContent = '0';
                updateScreenshotsGrid();
                showToast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æˆªå›¾');
            }
        }

        async function sendNotification(intensity) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸš¨ æ£€æµ‹åˆ°è¿åŠ¨!', {
                    body: `è¿åŠ¨å¼ºåº¦: ${intensity.toFixed(1)}%
æ—¶é—´: ${new Date().toLocaleTimeString('zh-CN')}`,
                    icon: '/icon.png',
                    badge: '/badge.png',
                    vibrate: [200, 100, 200]
                });

                stats.notifications++;
                document.getElementById('notificationCount').textContent = stats.notifications;
            }
        }

        function playBeep() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            const volume = config.volume / 100;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // ============ ç”µæºç®¡ç† ============
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock å·²é‡Šæ”¾');
                    });
                }
            } catch (err) {
                console.error('Wake Lock è¯·æ±‚å¤±è´¥:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        function startDimTimer() {
            clearDimTimer();
            dimTimer = setTimeout(() => {
                if (isDetecting && !isDimmed) {
                    dimScreen();
                }
            }, config.dimTimeout * 1000);
        }

        function clearDimTimer() {
            if (dimTimer) {
                clearTimeout(dimTimer);
                dimTimer = null;
            }
        }

        function dimScreen() {
            const overlay = document.getElementById('dimOverlay');
            overlay.style.opacity = config.dimLevel / 100;
            overlay.style.display = 'block';
            isDimmed = true;
            showToast('ğŸ’¤ å·²è¿›å…¥çœç”µæ¨¡å¼', 3000);
        }

        function restoreBrightness() {
            const overlay = document.getElementById('dimOverlay');
            overlay.style.display = 'none';
            isDimmed = false;
        }

        function initUserActivityTracking() {
            const events = ['touchstart', 'touchmove', 'touchend', 'click', 'scroll'];

            events.forEach(event => {
                document.addEventListener(event, () => {
                    if (isDimmed) {
                        restoreBrightness();
                    }

                    if (isDetecting && config.autoDimEnabled) {
                        startDimTimer();
                    }
                }, { passive: true });
            });
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                if (isDetecting) {
                    // é¡µé¢éšè—æ—¶æš‚åœ
                    console.log('é¡µé¢éšè—,æš‚åœæ£€æµ‹');
                }
                clearDimTimer();
            } else {
                if (isDetecting && config.autoDimEnabled) {
                    startDimTimer();
                }
            }
        }

        // ============ ç”µæ± ç›‘æ§ ============
        async function initBatteryMonitor() {
            try {
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    updateBatteryInfo(battery);

                    battery.addEventListener('levelchange', () => updateBatteryInfo(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryInfo(battery));
                    battery.addEventListener('chargingtimechange', () => updateBatteryInfo(battery));
                    battery.addEventListener('dischargingtimechange', () => updateBatteryInfo(battery));
                } else {
                    document.getElementById('batteryPercent').textContent = 'N/A';
                    document.getElementById('batteryCharging').textContent = 'ä¸æ”¯æŒç”µæ± API';
                }
            } catch (error) {
                console.error('ç”µæ± APIé”™è¯¯:', error);
            }
        }

        function updateBatteryInfo(battery) {
            const level = Math.round(battery.level * 100);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('batteryPercent').textContent = level + '%';
            document.getElementById('battery-status').textContent = level + '%';
            document.getElementById('batteryFill').style.width = level + '%';

            // æ›´æ–°ç”µæ± å›¾æ ‡
            let icon = 'ğŸ”‹';
            if (battery.charging) {
                icon = 'âš¡';
            } else if (level <= 20) {
                icon = 'ğŸª«';
            }
            document.getElementById('battery-icon').textContent = icon;

            // æ›´æ–°å……ç”µçŠ¶æ€
            if (battery.charging) {
                document.getElementById('batteryCharging').textContent = 'âš¡ å……ç”µä¸­';
                document.getElementById('batteryFill').classList.remove('low');

                // è®¡ç®—å……ç”µé€Ÿåº¦
                recordBatteryLevel(level, true);
                const chargeSpeed = calculateChargeSpeed();

                if (chargeSpeed > 0) {
                    const remainingPercent = 100 - level;
                    const hoursToFull = remainingPercent / chargeSpeed;
                    document.getElementById('batteryTime').textContent = 
                        `é¢„è®¡ ${formatTime(hoursToFull)} å……æ»¡`;
                } else if (battery.chargingTime && battery.chargingTime !== Infinity) {
                    document.getElementById('batteryTime').textContent = 
                        `é¢„è®¡ ${formatTime(battery.chargingTime / 3600)} å……æ»¡`;
                } else {
                    document.getElementById('batteryTime').textContent = 'è®¡ç®—ä¸­...';
                }
            } else {
                document.getElementById('batteryCharging').textContent = 'ğŸ”‹ æœªå……ç”µ';

                if (level <= 20) {
                    document.getElementById('batteryFill').classList.add('low');
                }

                if (battery.dischargingTime && battery.dischargingTime !== Infinity) {
                    document.getElementById('batteryTime').textContent = 
                        `å¯ç”¨ ${formatTime(battery.dischargingTime / 3600)}`;
                } else {
                    document.getElementById('batteryTime').textContent = 'è®¡ç®—å‰©ä½™æ—¶é—´...';
                }
            }
        }

        function recordBatteryLevel(level, charging) {
            const now = Date.now();
            batteryChargeHistory.push({ level, time: now, charging });

            // åªä¿ç•™5åˆ†é’Ÿå†…çš„æ•°æ®
            const fiveMinutesAgo = now - 5 * 60 * 1000;
            batteryChargeHistory = batteryChargeHistory.filter(record => record.time > fiveMinutesAgo);
        }

        function calculateChargeSpeed() {
            if (batteryChargeHistory.length < 2) return 0;

            const first = batteryChargeHistory[0];
            const last = batteryChargeHistory[batteryChargeHistory.length - 1];

            const timeDiff = (last.time - first.time) / 1000 / 3600; // å°æ—¶
            const levelDiff = last.level - first.level;

            if (timeDiff > 0 && levelDiff > 0) {
                return levelDiff / timeDiff; // %/å°æ—¶
            }

            return 0;
        }

        function formatTime(hours) {
            if (hours < 1) {
                return `${Math.round(hours * 60)} åˆ†é’Ÿ`;
            } else {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return m > 0 ? `${h} å°æ—¶ ${m} åˆ†é’Ÿ` : `${h} å°æ—¶`;
            }
        }

        // ============ UI æ›´æ–° ============
        function updateDetectionBox() {
            const box = document.getElementById('detectionBox');
            const container = document.getElementById('videoContainer');

            const size = config.detectionArea;
            box.style.width = size + '%';
            box.style.height = size + '%';
            box.style.left = ((100 - size) / 2) + '%';
            box.style.top = ((100 - size) / 2) + '%';
        }

        // ============ é€šçŸ¥æƒé™ ============
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(async () => {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        showToast('âœ… é€šçŸ¥æƒé™å·²æˆäºˆ');
                    }
                }, 2000);
            }
        }

        // ============ è®¾å¤‡æ£€æµ‹ ============
        function checkDeviceType() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (!isMobile) {
                document.querySelector('.desktop-warning').style.display = 'flex';
            }
        }

        // ============ æç¤ºä¿¡æ¯ ============
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showWelcomeToast() {
            setTimeout(() => {
                showToast('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½è¿åŠ¨æ£€æµ‹ç³»ç»Ÿ', 5000);
            }, 500);
        }

        // ============ è®¾ç½®æŒä¹…åŒ– ============
        function saveSettings() {
            localStorage.setItem('motionDetectorConfig', JSON.stringify(config));
            localStorage.setItem('motionDetectorStats', JSON.stringify(stats));
        }

        function loadSettings() {
            const savedConfig = localStorage.getItem('motionDetectorConfig');
            const savedStats = localStorage.getItem('motionDetectorStats');

            if (savedConfig) {
                config = { ...config, ...JSON.parse(savedConfig) };

                // æ¢å¤UIçŠ¶æ€
                Object.keys(config).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = config[key];
                        } else if (element.type === 'range') {
                            element.value = config[key];
                            updateSliderValue(key, config[key]);
                        }
                    }
                });
            }

            if (savedStats) {
                stats = JSON.parse(savedStats);
                document.getElementById('detectionCount').textContent = stats.detections;
                document.getElementById('vibrateCount').textContent = stats.vibrations;
                document.getElementById('screenshotCount').textContent = stats.screenshots;
                document.getElementById('notificationCount').textContent = stats.notifications;
            }

            updateDetectionBox();
        }

        // ============ å…¨å±€å‡½æ•° ============
        window.viewScreenshot = viewScreenshot;
    </script>
</body>
</html>
