<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>3D伪光追&光锥场景展示</title>
  <style>
    html, body {height: 100%; margin: 0;}
    body {
      background: #111;
      overflow: hidden;
      font-family: 'Arial', 'Microsoft YaHei', sans-serif;
    }
    #ui-panel {
      position: absolute;
      right: 0; top: 0;
      background: rgba(20,20,20, 0.8);
      color: #fff;
      padding: 24px 16px 24px 16px;
      box-shadow: -2px 2px 16px #0008;
      border-bottom-left-radius: 24px;
      z-index: 2;
      min-width:180px;
      max-width:240px;
      transition: opacity 0.4s;
    }
    .row {margin:12px 8px;}
    label {font-size:15px;}
    input[type=range] {width:98%;}
    canvas {display:block; width:100vw; height:100vh;}
    .color-inp {width:48px; height:22px;}
    @media (max-width:560px) {
      #ui-panel {min-width:120px;max-width:150px;}
      .row {margin:7px 2px;}
    }
  </style>
</head>
<body>
<div id="ui-panel">
  <div class="row"><label>灯光颜色: <input id="color" class="color-inp" type="color" value="#ffdd55"></label></div>
  <div class="row"><label>亮度: <input id="intensity" type="range" min="0" max="2" step="0.01" value="1"></label></div>
  <div class="row"><label>光锥角度: <input id="cone" type="range" min="10" max="90" value="30"></label></div>
  <div class="row"><label>反射强度: <input id="mirror" type="range" min="0" max="1" step="0.01" value="0.78"></label></div>
  <div class="row"><label>地板粗糙: <input id="roughness" type="range" min="0" max="1" step="0.01" value="0.12"></label></div>
</div>
<canvas id="cvs"></canvas>
<script>
const canvas = document.getElementById('cvs'), ctx = canvas.getContext('2d');
let W=window.innerWidth,H=window.innerHeight;canvas.width=W;canvas.height=H;
window.onresize=()=>{W=window.innerWidth;H=window.innerHeight;canvas.width=W;canvas.height=H;}

function hex2rgb(hex) {
  hex=hex.replace('#','');
  const num = parseInt(hex, 16);
  return [num>>16, (num>>8)&255, num&255];
}

// 参数
let params = {
  color: [255,221,85],
  intensity: 1.0,
  cone: 30,
  mirror: 0.78,
  roughness: 0.12
};
document.getElementById('color').oninput = e => params.color = hex2rgb(e.target.value);
document.getElementById('intensity').oninput = e => params.intensity = +e.target.value;
document.getElementById('cone').oninput = e => params.cone = +e.target.value;
document.getElementById('mirror').oninput = e => params.mirror = +e.target.value;
document.getElementById('roughness').oninput= e=>params.roughness = +e.target.value;

// 3D伪光追&场景简化
function renderScene() {
  ctx.clearRect(0,0,W,H);

  // 参数
  const floorY = H*0.68;
  const roomColor = "#17171d";
  ctx.fillStyle = roomColor;
  ctx.fillRect(0,0,W,H);

  // 地板反射
  ctx.save();
  ctx.translate(0, 2*floorY);
  ctx.scale(1, -1);

  // 光锥反射fake
  drawVolumetricLight(W/2, floorY-128, params.cone, 240, params.color, params.intensity*params.mirror*0.75, true);
  ctx.globalAlpha=0.6*(1-params.roughness);
  ctx.fillStyle="#22252a";
  ctx.fillRect(W*0.12, floorY-1, W*0.76, H-floorY+1);
  ctx.globalAlpha=1.0;
  ctx.restore();

  // 地板自身
  ctx.fillStyle = "#212227";
  ctx.fillRect(W*0.12, floorY, W*0.76, H-floorY);

  // 黑色房间简化
  ctx.strokeStyle="#333";
  ctx.lineWidth=7;
  ctx.strokeRect(W*0.12,floorY-H*0.46,W*0.76,H*0.46+H*0.001);

  // 光锥
  drawVolumetricLight(W/2, floorY-128, params.cone, 240, params.color, params.intensity, false);

  // 灯光源
  drawLamp(W/2,floorY-128,params.color);

  // 地板反射高光
  let grad = ctx.createRadialGradient(W/2,floorY+12,8,W/2,floorY+45,300);
  grad.addColorStop(0,`rgba(${params.color[0]},${params.color[1]},${params.color[2]},${0.22*params.intensity})`);
  grad.addColorStop(1,"rgba(34,34,38,0)");
  ctx.beginPath();
  ctx.arc(W/2,floorY+12,240,0,Math.PI,true);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();
}

function drawVolumetricLight(x,y,angleDeg,len,color,intensity,mirror) {
  const a = Math.PI*angleDeg/180;
  ctx.save();
  ctx.globalAlpha = 0.28*intensity*(mirror?0.75:1);
  let g = ctx.createRadialGradient(x,y,12,x,y,len*0.95);
  g.addColorStop(0,`rgba(${color[0]},${color[1]},${color[2]},0.28)`);
  g.addColorStop(0.35,`rgba(${color[0]},${color[1]},${color[2]},0.13)`);
  g.addColorStop(1,`rgba(${color[0]},${color[1]},${color[2]},0.01)`);
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.arc(x,y,len,-a/2,a/2,false);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function drawLamp(x,y,color) {
  let c=`rgb(${color[0]},${color[1]},${color[2]})`;  
  ctx.save();
  // 外圈光晕
  let g=ctx.createRadialGradient(x,y,6,x,y,45);
  g.addColorStop(0,`rgba(${color[0]},${color[1]},${color[2]},0.65)`);
  g.addColorStop(1,"rgba(40,40,50,0)");
  ctx.beginPath();ctx.arc(x,y,45,0,2*Math.PI);ctx.closePath();
  ctx.fillStyle=g;ctx.fill();
  // 灯体
  ctx.beginPath();
  ctx.arc(x,y,14,0,2*Math.PI);
  ctx.closePath();
  ctx.fillStyle =c;ctx.fill();
  ctx.strokeStyle="#fff9";ctx.lineWidth=2;ctx.stroke();
  // 灯座
  ctx.fillStyle="#444";
  ctx.fillRect(x-9,y+13,18,12);
  ctx.restore();
}

function animate() {
  renderScene();
  requestAnimationFrame(animate);
}
animate();

</script>
</body>
</html>
