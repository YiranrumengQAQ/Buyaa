<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤‡å¿˜å½• - å¤šåŠŸèƒ½ç¬”è®°åº”ç”¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-primary);
            padding: 50px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.5s ease-in;
        }

        .login-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .password-input {
            width: 100%;
            padding: 15px 50px 15px 50px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.2em;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: var(--primary-color);
        }

        .password-strength {
            margin-top: 10px;
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
        }

        .strength-weak { background: var(--danger-color); width: 33%; }
        .strength-medium { background: var(--warning-color); width: 66%; }
        .strength-strong { background: var(--success-color); width: 100%; }

        .strength-text {
            margin-top: 5px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .error-message {
            background: var(--danger-color);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .password-tips {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            text-align: left;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .password-tips ul {
            margin-top: 10px;
            padding-left: 20px;
        }

        .password-tips li {
            margin: 5px 0;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            text-align: left;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .logout-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary-color);
        }

        .toolbar {
            background: var(--bg-secondary);
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .input-group {
            flex: 1;
            min-width: 250px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        button:active {
            transform: scale(0.98);
        }

        .filters {
            background: var(--bg-secondary);
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .notes-container {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .note-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .note-card.priority-high {
            border-left-color: var(--danger-color);
        }

        .note-card.priority-medium {
            border-left-color: var(--warning-color);
        }

        .note-card.priority-low {
            border-left-color: var(--success-color);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .note-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .note-category {
            display: inline-block;
            padding: 4px 12px;
            background: var(--secondary-color);
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .note-content {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
            word-wrap: break-word;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .note-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.9em;
            border-radius: 8px;
        }

        .stats-bar {
            background: var(--bg-secondary);
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            border-top: 2px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .priority-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .priority-high { background: var(--danger-color); }
        .priority-medium { background: var(--warning-color); }
        .priority-low { background: var(--success-color); }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .notes-container { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; }
            .button-group { width: 100%; }
            button { width: 100%; justify-content: center; }
            .login-box { padding: 30px 20px; }
            header { flex-direction: column; gap: 15px; text-align: center; }
            .header-left { text-align: center; }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-icon">ğŸ”</div>
            <h2 class="login-title">æ™ºèƒ½å¤‡å¿˜å½•</h2>
            <p class="login-subtitle" id="loginSubtitle">é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®å¯†ç </p>
            
            <div class="input-wrapper">
                <span class="input-icon">ğŸ”‘</span>
                <input type="password" id="passwordInput" class="password-input" placeholder="è¾“å…¥å¯†ç ..." />
                <span class="toggle-password" onclick="togglePasswordVisibility('passwordInput', this)">ğŸ‘ï¸</span>
            </div>
            
            <div id="confirmPasswordWrapper" class="input-wrapper">
                <span class="input-icon">ğŸ”‘</span>
                <input type="password" id="confirmPasswordInput" class="password-input" placeholder="ç¡®è®¤å¯†ç ..." />
                <span class="toggle-password" onclick="togglePasswordVisibility('confirmPasswordInput', this)">ğŸ‘ï¸</span>
            </div>

            <div id="passwordStrength" class="password-strength hidden">
                <div class="strength-bar" id="strengthBar"></div>
            </div>
            <div id="strengthText" class="strength-text"></div>

            <button class="login-btn" onclick="handleAuth()" id="authButton">è®¾ç½®å¯†ç </button>
            
            <div id="errorMessage"></div>

            <div id="passwordTips" class="password-tips">
                <strong>ğŸ›¡ï¸ å¯†ç å®‰å…¨æç¤ºï¼š</strong>
                <ul>
                    <li>å»ºè®®ä½¿ç”¨8ä½ä»¥ä¸Šå­—ç¬¦</li>
                    <li>åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šç¬¦å·æ›´å®‰å…¨</li>
                    <li>è¯·ç‰¢è®°å¯†ç ï¼Œå¿˜è®°åæ— æ³•æ‰¾å›</li>
                    <li>å¯†ç ä¿å­˜åœ¨æœ¬åœ°ï¼Œæ•°æ®å®Œå…¨ç§å¯†</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <header>
                <div class="header-left">
                    <h1>ğŸ“ æ™ºèƒ½å¤‡å¿˜å½•</h1>
                    <p class="subtitle">åŠŸèƒ½å¼ºå¤§ | æ•°æ®æ°¸ä¹…ä¿å­˜ | å¯†ç ä¿æŠ¤</p>
                </div>
                <button class="logout-btn" onclick="logout()">ğŸ”“ é€€å‡ºç™»å½•</button>
            </header>

            <div class="toolbar">
                <div class="input-group">
                    <input type="text" id="noteTitle" placeholder="ğŸ“Œ è¾“å…¥æ ‡é¢˜..." />
                </div>
                <div class="input-group">
                    <textarea id="noteContent" placeholder="âœï¸ è¾“å…¥å†…å®¹..."></textarea>
                </div>
                <div class="input-group">
                    <select id="noteCategory">
                        <option value="å·¥ä½œ">ğŸ’¼ å·¥ä½œ</option>
                        <option value="å­¦ä¹ ">ğŸ“š å­¦ä¹ </option>
                        <option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option>
                        <option value="è´­ç‰©">ğŸ›’ è´­ç‰©</option>
                        <option value="å¥åº·">ğŸ’ª å¥åº·</option>
                        <option value="æ—…è¡Œ">âœˆï¸ æ—…è¡Œ</option>
                        <option value="å…¶ä»–">ğŸ“‹ å…¶ä»–</option>
                    </select>
                </div>
                <div class="input-group">
                    <select id="notePriority">
                        <option value="low">ä½ä¼˜å…ˆçº§</option>
                        <option value="medium" selected>ä¸­ä¼˜å…ˆçº§</option>
                        <option value="high">é«˜ä¼˜å…ˆçº§</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="addNote()">â• æ·»åŠ å¤‡å¿˜</button>
                    <button class="btn-warning" onclick="exportNotes()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                    <button class="btn-success" onclick="importNotes()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <button class="btn-danger" onclick="changePassword()">ğŸ” ä¿®æ”¹å¯†ç </button>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" onclick="filterNotes('all')">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterNotes('å·¥ä½œ')">ğŸ’¼ å·¥ä½œ</button>
                <button class="filter-btn" onclick="filterNotes('å­¦ä¹ ')">ğŸ“š å­¦ä¹ </button>
                <button class="filter-btn" onclick="filterNotes('ç”Ÿæ´»')">ğŸ  ç”Ÿæ´»</button>
                <button class="filter-btn" onclick="filterNotes('è´­ç‰©')">ğŸ›’ è´­ç‰©</button>
                <button class="filter-btn" onclick="filterNotes('å¥åº·')">ğŸ’ª å¥åº·</button>
                <button class="filter-btn" onclick="filterNotes('æ—…è¡Œ')">âœˆï¸ æ—…è¡Œ</button>
                <button class="filter-btn" onclick="filterNotes('å…¶ä»–')">ğŸ“‹ å…¶ä»–</button>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢å¤‡å¿˜å½•..." oninput="searchNotes()" />
                </div>
            </div>

            <div class="notes-container" id="notesContainer">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/>
                    </svg>
                    <h2>è¿˜æ²¡æœ‰å¤‡å¿˜å½•</h2>
                    <p>ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å¤‡å¿˜"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€æ¡å¤‡å¿˜å½•</p>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="totalNotes">0</div>
                    <div class="stat-label">æ€»å¤‡å¿˜æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="highPriority">0</div>
                    <div class="stat-label">é«˜ä¼˜å…ˆçº§</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="mediumPriority">0</div>
                    <div class="stat-label">ä¸­ä¼˜å…ˆçº§</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lowPriority">0</div>
                    <div class="stat-label">ä½ä¼˜å…ˆçº§</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h2>ç¼–è¾‘å¤‡å¿˜å½•</h2>
            <input type="text" id="editTitle" placeholder="æ ‡é¢˜" style="margin-bottom: 10px;" />
            <textarea id="editContent" placeholder="å†…å®¹" style="margin-bottom: 10px;"></textarea>
            <select id="editCategory" style="margin-bottom: 10px;">
                <option value="å·¥ä½œ">ğŸ’¼ å·¥ä½œ</option>
                <option value="å­¦ä¹ ">ğŸ“š å­¦ä¹ </option>
                <option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option>
                <option value="è´­ç‰©">ğŸ›’ è´­ç‰©</option>
                <option value="å¥åº·">ğŸ’ª å¥åº·</option>
                <option value="æ—…è¡Œ">âœˆï¸ æ—…è¡Œ</option>
                <option value="å…¶ä»–">ğŸ“‹ å…¶ä»–</option>
            </select>
            <select id="editPriority" style="margin-bottom: 20px;">
                <option value="low">ä½ä¼˜å…ˆçº§</option>
                <option value="medium">ä¸­ä¼˜å…ˆçº§</option>
                <option value="high">é«˜ä¼˜å…ˆçº§</option>
            </select>
            <div class="button-group">
                <button class="btn-primary" onclick="saveEdit()">ä¿å­˜</button>
                <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h2>ä¿®æ”¹å¯†ç </h2>
            <div class="input-wrapper" style="margin-bottom: 15px;">
                <input type="password" id="oldPassword" class="password-input" placeholder="è¾“å…¥æ—§å¯†ç ..." />
            </div>
            <div class="input-wrapper" style="margin-bottom: 15px;">
                <input type="password" id="newPassword" class="password-input" placeholder="è¾“å…¥æ–°å¯†ç ..." />
            </div>
            <div class="input-wrapper" style="margin-bottom: 15px;">
                <input type="password" id="confirmNewPassword" class="password-input" placeholder="ç¡®è®¤æ–°å¯†ç ..." />
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="saveNewPassword()">ä¿å­˜</button>
                <button class="btn-secondary" onclick="closeChangePasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)" />

    <script>
        // ========== å¯†ç åŠ å¯†å’Œè®¤è¯ç³»ç»Ÿ ==========
        
        // SHA-256 å“ˆå¸Œå‡½æ•°å®ç°
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
        function isFirstTime() {
            return !localStorage.getItem('appPasswordHash');
        }

        // è®¾ç½®å¯†ç 
        async function setPassword(password) {
            const hash = await hashPassword(password);
            localStorage.setItem('appPasswordHash', hash);
        }

        // éªŒè¯å¯†ç 
        async function verifyPassword(password) {
            const hash = await hashPassword(password);
            const storedHash = localStorage.getItem('appPasswordHash');
            return hash === storedHash;
        }

        // æ£€æŸ¥å¯†ç å¼ºåº¦
        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            return strength;
        }

        // æ›´æ–°å¯†ç å¼ºåº¦æ˜¾ç¤º
        function updatePasswordStrength() {
            const password = document.getElementById('passwordInput').value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            const strengthContainer = document.getElementById('passwordStrength');

            if (!password || !isFirstTime()) {
                strengthContainer.classList.add('hidden');
                return;
            }

            strengthContainer.classList.remove('hidden');
            const strength = checkPasswordStrength(password);

            strengthBar.className = 'strength-bar';
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼±';
                strengthText.style.color = 'var(--danger-color)';
            } else if (strength <= 4) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šä¸­';
                strengthText.style.color = 'var(--warning-color)';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼º';
                strengthText.style.color = 'var(--success-color)';
            }
        }

        // åˆ‡æ¢å¯†ç å¯è§æ€§
        function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.textContent = 'ğŸ‘ï¸';
            }
        }

        // å¤„ç†ç™»å½•/è®¾ç½®å¯†ç 
        async function handleAuth() {
            const password = document.getElementById('passwordInput').value.trim();
            const errorDiv = document.getElementById('errorMessage');

            if (!password) {
                showError('è¯·è¾“å…¥å¯†ç ï¼');
                return;
            }

            if (isFirstTime()) {
                // é¦–æ¬¡è®¾ç½®å¯†ç 
                const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();
                
                if (password.length < 6) {
                    showError('å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼');
                    return;
                }

                if (password !== confirmPassword) {
                    showError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
                    return;
                }

                await setPassword(password);
                showToast('å¯†ç è®¾ç½®æˆåŠŸï¼');
                enterApp();
            } else {
                // éªŒè¯å¯†ç 
                const isValid = await verifyPassword(password);
                if (isValid) {
                    showToast('ç™»å½•æˆåŠŸï¼');
                    enterApp();
                } else {
                    showError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
                    document.getElementById('passwordInput').value = '';
                }
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 3000);
        }

        // è¿›å…¥åº”ç”¨
        function enterApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            sessionStorage.setItem('authenticated', 'true');
            renderNotes();
            updateStats();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                sessionStorage.removeItem('authenticated');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                showToast('å·²é€€å‡ºç™»å½•');
            }
        }

        // ä¿®æ”¹å¯†ç 
        function changePassword() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }

        // ä¿å­˜æ–°å¯†ç 
        async function saveNewPassword() {
            const oldPassword = document.getElementById('oldPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼', 'error');
                return;
            }

            const isValid = await verifyPassword(oldPassword);
            if (!isValid) {
                showToast('æ—§å¯†ç é”™è¯¯ï¼', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                return;
            }

            await setPassword(newPassword);
            closeChangePasswordModal();
            showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        // å…³é—­ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        // åˆå§‹åŒ–ç™»å½•ç•Œé¢
        function initLoginPage() {
            const isFirst = isFirstTime();
            const subtitle = document.getElementById('loginSubtitle');
            const confirmWrapper = document.getElementById('confirmPasswordWrapper');
            const authButton = document.getElementById('authButton');
            const tipsDiv = document.getElementById('passwordTips');
            const passwordInput = document.getElementById('passwordInput');

            if (isFirst) {
                subtitle.textContent = 'é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®å¯†ç ';
                confirmWrapper.classList.remove('hidden');
                authButton.textContent = 'è®¾ç½®å¯†ç ';
                tipsDiv.classList.remove('hidden');
                passwordInput.addEventListener('input', updatePasswordStrength);
            } else {
                subtitle.textContent = 'æ¬¢è¿å›æ¥ï¼Œè¯·è¾“å…¥å¯†ç ';
                confirmWrapper.classList.add('hidden');
                authButton.textContent = 'ç™»å½•';
                tipsDiv.classList.add('hidden');
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (sessionStorage.getItem('authenticated') === 'true') {
                enterApp();
            }
        }

        // ========== å¤‡å¿˜å½•åŠŸèƒ½ ==========
        
        let notes = JSON.parse(localStorage.getItem('smartNotes')) || [];
        let currentFilter = 'all';
        let editingId = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            initLoginPage();
        };

        // æ·»åŠ å¤‡å¿˜å½•
        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const category = document.getElementById('noteCategory').value;
            const priority = document.getElementById('notePriority').value;

            if (!title || !content) {
                showToast('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹ï¼', 'error');
                return;
            }

            const note = {
                id: Date.now(),
                title,
                content,
                category,
                priority,
                createdAt: new Date().toLocaleString('zh-CN'),
                updatedAt: new Date().toLocaleString('zh-CN')
            };

            notes.unshift(note);
            saveToStorage();
            renderNotes();
            updateStats();

            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            
            showToast('å¤‡å¿˜å½•æ·»åŠ æˆåŠŸï¼');
        }

        // ä¿å­˜åˆ°localStorage
        function saveToStorage() {
            localStorage.setItem('smartNotes', JSON.stringify(notes));
        }

        // æ¸²æŸ“å¤‡å¿˜å½•
        function renderNotes() {
            const container = document.getElementById('notesContainer');
            
            let filteredNotes = notes;
            if (currentFilter !== 'all') {
                filteredNotes = notes.filter(note => note.category === currentFilter);
            }

            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/>
                        </svg>
                        <h2>æ²¡æœ‰æ‰¾åˆ°å¤‡å¿˜å½•</h2>
                        <p>å°è¯•åˆ‡æ¢åˆ†ç±»æˆ–æœç´¢å…¶ä»–å…³é”®è¯</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredNotes.map(note => `
                <div class="note-card priority-${note.priority}">
                    <span class="priority-badge priority-${note.priority}">
                        ${note.priority === 'high' ? 'é«˜' : note.priority === 'medium' ? 'ä¸­' : 'ä½'}
                    </span>
                    <div class="note-header">
                        <div>
                            <div class="note-title">${escapeHtml(note.title)}</div>
                            <span class="note-category">${note.category}</span>
                        </div>
                    </div>
                    <div class="note-content">${escapeHtml(note.content)}</div>
                    <div class="note-meta">
                        <div>
                            <div>åˆ›å»ºï¼š${note.createdAt}</div>
                            ${note.updatedAt !== note.createdAt ? `<div>æ›´æ–°ï¼š${note.updatedAt}</div>` : ''}
                        </div>
                        <div class="note-actions">
                            <button class="btn-primary action-btn" onclick="editNote(${note.id})">âœï¸ ç¼–è¾‘</button>
                            <button class="btn-danger action-btn" onclick="deleteNote(${note.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ç¼–è¾‘å¤‡å¿˜å½•
        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            editingId = id;
            document.getElementById('editTitle').value = note.title;
            document.getElementById('editContent').value = note.content;
            document.getElementById('editCategory').value = note.category;
            document.getElementById('editPriority').value = note.priority;
            document.getElementById('editModal').style.display = 'flex';
        }

        // ä¿å­˜ç¼–è¾‘
        function saveEdit() {
            const note = notes.find(n => n.id === editingId);
            if (!note) return;

            note.title = document.getElementById('editTitle').value.trim();
            note.content = document.getElementById('editContent').value.trim();
            note.category = document.getElementById('editCategory').value;
            note.priority = document.getElementById('editPriority').value;
            note.updatedAt = new Date().toLocaleString('zh-CN');

            if (!note.title || !note.content) {
                showToast('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }

            saveToStorage();
            renderNotes();
            updateStats();
            closeModal();
            showToast('å¤‡å¿˜å½•æ›´æ–°æˆåŠŸï¼');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            editingId = null;
        }

        // åˆ é™¤å¤‡å¿˜å½•
        function deleteNote(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ')) return;
            
            notes = notes.filter(note => note.id !== id);
            saveToStorage();
            renderNotes();
            updateStats();
            showToast('å¤‡å¿˜å½•å·²åˆ é™¤ï¼', 'warning');
        }

        // ç­›é€‰å¤‡å¿˜å½•
        function filterNotes(category) {
            currentFilter = category;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderNotes();
        }

        // æœç´¢å¤‡å¿˜å½•
        function searchNotes() {
            const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
            const container = document.getElementById('notesContainer');

            if (!keyword) {
                renderNotes();
                return;
            }

            const filtered = notes.filter(note => 
                note.title.toLowerCase().includes(keyword) ||
                note.content.toLowerCase().includes(keyword) ||
                note.category.includes(keyword)
            );

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¤‡å¿˜å½•</h2>
                        <p>å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(note => `
                <div class="note-card priority-${note.priority}">
                    <span class="priority-badge priority-${note.priority}">
                        ${note.priority === 'high' ? 'é«˜' : note.priority === 'medium' ? 'ä¸­' : 'ä½'}
                    </span>
                    <div class="note-header">
                        <div>
                            <div class="note-title">${escapeHtml(note.title)}</div>
                            <span class="note-category">${note.category}</span>
                        </div>
                    </div>
                    <div class="note-content">${escapeHtml(note.content)}</div>
                    <div class="note-meta">
                        <div>
                            <div>åˆ›å»ºï¼š${note.createdAt}</div>
                            ${note.updatedAt !== note.createdAt ? `<div>æ›´æ–°ï¼š${note.updatedAt}</div>` : ''}
                        </div>
                        <div class="note-actions">
                            <button class="btn-primary action-btn" onclick="editNote(${note.id})">âœï¸ ç¼–è¾‘</button>
                            <button class="btn-danger action-btn" onclick="deleteNote(${note.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // å¯¼å‡ºæ•°æ®
        function exportNotes() {
            if (notes.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼', 'error');
                return;
            }

            const dataStr = JSON.stringify(notes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å¤‡å¿˜å½•å¯¼å‡º_${new Date().toLocaleDateString()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        // å¯¼å…¥æ•°æ®
        function importNotes() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (!Array.isArray(importedNotes)) {
                        throw new Error('Invalid format');
                    }
                    
                    if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${importedNotes.length} æ¡å¤‡å¿˜å½•å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ã€‚`)) {
                        notes = importedNotes;
                        saveToStorage();
                        renderNotes();
                        updateStats();
                        showToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    showToast('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalNotes').textContent = notes.length;
            document.getElementById('highPriority').textContent = notes.filter(n => n.priority === 'high').length;
            document.getElementById('mediumPriority').textContent = notes.filter(n => n.priority === 'medium').length;
            document.getElementById('lowPriority').textContent = notes.filter(n => n.priority === 'low').length;
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            if (type === 'error') {
                toast.style.background = 'var(--danger-color)';
            } else if (type === 'warning') {
                toast.style.background = 'var(--warning-color)';
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const changePasswordModal = document.getElementById('changePasswordModal');
            if (event.target === editModal) {
                closeModal();
            }
            if (event.target === changePasswordModal) {
                closeChangePasswordModal();
            }
        };

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Enteré”®ç™»å½•/è®¾ç½®å¯†ç 
            if (e.key === 'Enter' && !document.getElementById('loginPage').classList.contains('hidden')) {
                handleAuth();
            }
            // Ctrl/Cmd + Enter å¿«é€Ÿæ·»åŠ 
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !document.getElementById('mainApp').classList.contains('hidden')) {
                addNote();
            }
            // ESC å…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                closeModal();
                closeChangePasswordModal();
            }
        });
    </script>
</body>
</html>
